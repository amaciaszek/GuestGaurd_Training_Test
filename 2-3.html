<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Facility Planning - Other Considerations</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{ --stage-max-width:1200px; --bg:#0e0e12; --accent:#00e0ff; --locked:#4a4a4a; --done:#22c55e; }
    *{box-sizing:border-box}
    body{ margin:0;min-height:100svh;display:grid;place-items:center;background:var(--bg);color:#e9eef5;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; }
    .frame{ width:min(95vw,var(--stage-max-width)); border-radius:28px;border:2px solid rgba(255,255,255,.12);
      box-shadow:0 20px 60px rgba(0,0,0,.55), inset 0 0 0 1px rgba(255,255,255,.04); overflow:hidden;background:#11151a; }
    .titlebar{ padding:14px 18px;border-bottom:1px solid rgba(255,255,255,.08); font-weight:600;letter-spacing:.2px;
      background:linear-gradient(180deg,rgba(255,255,255,.05),transparent); }
    .stage{ position:relative;width:100%;aspect-ratio:6000/4000; background:url('home3.jpg') center / 100% 100% no-repeat; }

    .hotspot{ position:absolute;display:grid;place-items:center; transform:translate(-50%,-50%);cursor:pointer;
      font-weight:800;color:#fff;font-size:14px;letter-spacing:.6px; border:6px solid transparent;background:rgba(255,255,255,.06);
      transition:transform .2s ease, opacity .2s ease, background .2s ease, border-color .2s ease, box-shadow .2s ease; }
    .hotspot.circle{ border-radius:50%; } .hotspot.oval{ border-radius:9999px; padding:6px 16px; }
    .hotspot.pill{ position:absolute;right:3%;bottom:5%;left:auto;top:auto;transform:none; border-radius:9999px;padding:10px 18px;font-size:16px; }
    .hotspot:not(.pill){font-size:0; line-height:0;}
    .hotspot.locked{ pointer-events:none; opacity:0; background:transparent; border-color:transparent; box-shadow:none; animation:none;}
    .hotspot.clickable{ pointer-events:auto; background:rgba(0,224,255,.12); border-color:var(--accent); animation:megaPulse 1.1s ease-in-out infinite; }
    .hotspot.clickable:hover{ transform:translate(-50%,-50%) scale(1.05); }
    .hotspot.pill.clickable:hover{ transform:none; }
    .hotspot.done{ pointer-events:auto; background:rgba(34,197,94,.22); border-color:var(--done);
      box-shadow:0 0 0 8px rgba(34,197,94,.25), 0 0 28px 8px rgba(34,197,94,.55); }
    @keyframes megaPulse{ 0%{box-shadow:0 0 0 0 rgba(0,224,255,.95), 0 0 26px 8px rgba(0,224,255,.95);}
      50%{box-shadow:0 0 0 18px rgba(0,224,255,0), 0 0 54px 18px rgba(0,224,255,1);}
      100%{box-shadow:0 0 0 0 rgba(0,224,255,0), 0 0 26px 8px rgba(0,224,255,.95);} }

    .inner-window{ position:absolute;display:none;flex-direction:column;z-index:20;background:#000;border-radius:16px;
      box-shadow:0 0 40px rgba(0,0,0,.8);overflow:hidden; }
    .inner-window.active{display:flex}
    .inner-window.large{ top:2%; left:2%; width:96%; height:96%; }
    .inner-window.small{ right:3%; bottom:6%; width:min(520px, 46%); max-height:60%; }

    .inner-window header{ background:#1a1a1a;color:#fff;padding:10px 12px;font-weight:700;
      display:flex;justify-content:space-between;align-items:center;gap:8px; }
    .inner-window header .right{display:flex;gap:8px;align-items:center}

    .viewer{ flex:1; display:flex; flex-direction:column; gap:12px; align-items:stretch; padding:12px; background:#000; height:100%; min-height:0; }
    .mediaArea{ position:relative; flex:1; min-height:0; display:grid; place-items:center; overflow:hidden; border-radius:10px; background:#000; }
    .mediaArea video, .mediaArea img{ max-width:100%; max-height:100%; object-fit:contain; }

    .caption{ position:absolute; left:0; right:0; bottom:0;
      background:linear-gradient(to top, rgba(0,0,0,.60), rgba(0,0,0,.35));
      color:#fff; padding:16px 20px; border-radius:0 0 10px 10px; font-size:16px; line-height:1.4; pointer-events:none; z-index:2; white-space:pre-wrap; }

    .subs-only{ display:flex; flex-direction:column; gap:12px; }
    .subs-text{ font-size:16px; line-height:1.45; color:#e9eef5; background:#0b0b0b; border:1px solid rgba(255,255,255,.15);
      border-radius:12px; padding:12px; max-height:28vh; overflow:auto; }

    .audio-ui{ flex:0 0 auto; width:100%; display:grid; gap:10px; }
    .row{display:flex;align-items:center;gap:10px;justify-content:space-between}
    .biglabel{font-weight:700}
    .controls{display:flex;gap:10px;flex-wrap:wrap}
    .btn{ background:#2a2a2a;color:#fff;border:1px solid rgba(255,255,255,.2); padding:10px 14px;border-radius:8px;cursor:pointer; }
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .bar{ position:relative;height:14px;border-radius:9999px;overflow:hidden;
      background:linear-gradient(90deg, rgba(255,255,255,.12), rgba(255,255,255,.06)); border:1px solid rgba(255,255,255,.2); pointer-events:none; }
    .fill{ position:absolute;inset:0 auto 0 0;width:0%; background:linear-gradient(90deg, #00e0ff, #22c55e); box-shadow:0 0 10px rgba(0,224,255,.9); }
    .time{font-variant-numeric:tabular-nums}
  </style>
</head>
<body>
  <main class="frame" role="main" aria-label="Training Chapter">
    <div class="titlebar">Facility Planning - Other Considerations</div>

    <section class="stage" aria-label="Main visual with hotspots">
      <!-- Hotspots will be generated by JavaScript -->
      
      <!-- viewer -->
      <div id="innerWindow" class="inner-window" aria-modal="true" role="dialog" aria-label="Content viewer">
        <header>
          <span id="viewerTitle">Narration</span>
          <div class="right"><button id="switchMedia" class="btn" style="display:none">Switch Media</button></div>
        </header>
        <div id="viewer" class="viewer"></div>
      </div>

      <audio id="vo" preload="metadata" src="2.3 Facility Planning_Other Considerations.wav"></audio>
    </section>
  </main>

  <script>
    // ========== MODULAR CONFIGURATION ==========
    const CONFIG = {
      title: "Facility Planning - Other Considerations",
      audioFile: "2.3 Facility Planning_Other Considerations.wav",
      backgroundImage: "home3.jpg",
      
      // Canvas dimensions (background image size)
      canvasDimensions: { width: 6000, height: 4000 },
      
      // Hotspot definitions with pixel coordinates
      hotspots: [
        {
          id: "b1",
          type: "oval",
          centerX: 1081, centerY: 340,    // Same location as previous pages
          width: 1854, height: 302,      
          tcStart: "00;00;00;00",
          tcEnd: "00;00;14;16",
          order: "first"
        },
        {
          id: "b2",
          type: "circle",
          centerX: 1535, centerY: 2479,  // Provided coordinates
          width: 940, height: 940,       
          tcStart: "00;00;14;16",
          tcEnd: "00;00;42;06",
          order: "second"
        },
        {
          id: "b3",
          type: "circle",
          centerX: 2584, centerY: 753,   // Provided coordinates
          width: 940, height: 940,
          tcStart: "00;00;42;06",
          tcEnd: "00;01;29;19",
          order: "mid"
        },
        {
          id: "b4",
          type: "circle",
          centerX: 4515, centerY: 875,   // Provided coordinates
          width: 940, height: 940,
          tcStart: "00;01;29;19",
          tcEnd: "00;01;55;23",
          order: "final"
        },
        {
          id: "b9",
          type: "pill",
          text: "Done",
          tcStart: "00;01;55;23",
          tcEnd: "00;02;12;05",
          order: "done"
        }
      ],
      
      // Content definitions
      subtitles: {
        b1: `[Intro]
Beyond utilities and hazards, there are other important considerations every host should keep in mind. These include creating safe spaces for emergencies, and managing noise levels for both guests and neighbors.`,
        b2: `[Safe Spaces in the Home]
A safe space in a home is an area where guests can remain during certain emergencies. This might be a lower-level room during severe weather, or a clearly marked gathering spot outside the home during a fire evacuation. Hosts should identify these spaces in advance and communicate them to guests. Providing this information builds confidence — and ensures guests know exactly where to go if danger arises.`,
        b3: `[Noise Levels & Standards]
Noise is another critical consideration. Excessive ambient noise not only disturbs neighbors — it can ruin the experience for your guests as well. So, what's unacceptable? Examples include loud ambient noise in your area and outside your home (such as construction, outside parties, traffic, et cetera), or constant disturbances like heavy machinery running nearby. We aren't trying to punish hosts for living in a louder noise environment – we test for ambient noise levels so guests know what to expect before they book their stay. It's also important to make your guests aware of their own noise levels. This will ensure a peaceful, enjoyable experience for everyone on the property including the host, guests from other parties, and neighbors.`,
        b4: `[Hypothetical Example]
Picture a stormy evening. Your guests know exactly which room to go to for shelter, because you've marked it as the safe space in your manual. Later that night, they enjoy a quiet stay without being disturbed by outside noise — because you've tested for acceptable noise levels and managed them properly. The result is a calm, secure environment that puts both guests and neighbors at ease.`,
        b9: `[Closing]
To summarize: every host should provide designated safe spaces for emergencies, and actively manage noise levels to avoid disruptions. By doing both, you'll create a safer, calmer, and more enjoyable experience for everyone involved.`
      },
      
      // Media files for hotspots
      media: {
        b2: ["Home Evacuation (Shutterstock).mov"],
        b3: ["Noise Testing (Shutterstock).jpg"]
      }
    };

    // ========== MODULAR TRAINING SYSTEM ==========
    class ModularTrainingSystem {
      constructor(config) {
        this.config = config;
        this.FPS = 30;
        this.STORAGE_KEY = 'hotspots_done';
        this.VER_KEY = 'hotspots_schema';
        this.SCHEMA_VERSION = 2;
        
        this.initializeStorage();
        this.createHotspots();
        this.setupEventListeners();
        this.applyStates();
        
        this.seg = {start:0, end:0, active:false, rafId:null, currentId:null};
        this.currentMediaIndex = 0;
      }
      
      initializeStorage() {
        const currentVer = parseInt(localStorage.getItem(this.VER_KEY) || '0', 10);
        if (currentVer !== this.SCHEMA_VERSION) {
          localStorage.removeItem(this.STORAGE_KEY);
          localStorage.setItem(this.VER_KEY, this.SCHEMA_VERSION);
        }
        this.done = new Set(JSON.parse(localStorage.getItem(this.STORAGE_KEY) || '[]'));
      }
      
      createHotspots() {
        const stage = document.querySelector('.stage');
        
        this.config.hotspots.forEach(hotspot => {
          const button = document.createElement('button');
          button.id = hotspot.id;
          button.className = `hotspot ${hotspot.type}`;
          button.dataset.id = hotspot.id;
          button.dataset.tcStart = hotspot.tcStart;
          button.dataset.tcEnd = hotspot.tcEnd;
          button.dataset.order = hotspot.order;
          
          if (hotspot.type === 'pill') {
            button.textContent = hotspot.text || 'Done';
            button.style.cssText = 'right:3%;bottom:5%;';
          } else {
            button.textContent = hotspot.id.replace('b', '');
            const leftPercent = (hotspot.centerX / this.config.canvasDimensions.width) * 100;
            const topPercent = (hotspot.centerY / this.config.canvasDimensions.height) * 100;
            const widthPercent = (hotspot.width / this.config.canvasDimensions.width) * 100;
            const heightPercent = (hotspot.height / this.config.canvasDimensions.height) * 100;
            
            button.style.cssText = `left:${leftPercent}%;top:${topPercent}%;width:${widthPercent}%;height:${heightPercent}%;`;
          }
          
          stage.appendChild(button);
        });
        
        // Create button lookup
        this.buttons = {};
        this.config.hotspots.forEach(h => {
          this.buttons[h.id] = document.getElementById(h.id);
        });
        
        // Create order lookup
        this.order = {
          first: this.config.hotspots.find(h => h.order === 'first')?.id,
          second: this.config.hotspots.find(h => h.order === 'second')?.id,
          mids: this.config.hotspots.filter(h => h.order === 'mid').map(h => h.id),
          final: this.config.hotspots.find(h => h.order === 'final')?.id,
          doneBtn: this.config.hotspots.find(h => h.order === 'done')?.id
        };
      }
      
      setupEventListeners() {
        this.config.hotspots.forEach(hotspot => {
          const button = document.getElementById(hotspot.id);
          button.addEventListener('click', () => {
            if (button.classList.contains('locked')) return;
            this.openFor(button);
          });
        });
        
        // Setup viewer elements
        this.innerWindow = document.getElementById('innerWindow');
        this.viewer = document.getElementById('viewer');
        this.switchMediaBtn = document.getElementById('switchMedia');
        this.viewerTitle = document.getElementById('viewerTitle');
        this.audio = document.getElementById('vo');
      }
      
      tcToSeconds(tc) {
        const parts = tc.split(/[;:]/).map(n => parseInt(n, 10) || 0);
        const [hh, mm, ss, ff] = [parts[0] || 0, parts[1] || 0, parts[2] || 0, parts[3] || 0];
        return hh * 3600 + mm * 60 + ss + (ff / this.FPS);
      }
      
      fmt(t) {
        return `${Math.floor(t / 60)}:${Math.floor(t % 60).toString().padStart(2, '0')}`;
      }
      
      saveDone() {
        localStorage.setItem(this.STORAGE_KEY, JSON.stringify([...this.done]));
      }
      
      setState(el, state) {
        el.classList.remove('clickable', 'locked', 'done');
        el.classList.add(state);
        el.setAttribute('aria-disabled', state === 'locked' ? 'true' : 'false');
      }
      
      applyStates() {
        this.config.hotspots.forEach(h => this.setState(this.buttons[h.id], 'locked'));
        
        if (!this.done.has(this.order.first)) {
          this.setState(this.buttons[this.order.first], 'clickable');
          return;
        }
        this.setState(this.buttons[this.order.first], 'done');
        
        if (!this.done.has(this.order.second)) {
          this.setState(this.buttons[this.order.second], 'clickable');
          return;
        }
        this.setState(this.buttons[this.order.second], 'done');
        
        let midsDone = true;
        this.order.mids.forEach(id => {
          if (this.done.has(id)) {
            this.setState(this.buttons[id], 'done');
          } else {
            this.setState(this.buttons[id], 'clickable');
            midsDone = false;
          }
        });
        
        if (this.done.has(this.order.final)) {
          this.setState(this.buttons[this.order.final], 'done');
          this.setState(this.buttons[this.order.doneBtn], 'clickable');
        } else if (midsDone) {
          this.setState(this.buttons[this.order.final], 'clickable');
          this.setState(this.buttons[this.order.doneBtn], 'locked');
        } else {
          this.setState(this.buttons[this.order.final], 'locked');
          this.setState(this.buttons[this.order.doneBtn], 'locked');
        }
      }
      
      buildAudioUI(total) {
        const ui = document.createElement('div');
        ui.className = 'audio-ui';
        ui.innerHTML = `
          <div class="row">
            <div class="biglabel">Narration</div>
            <div class="time"><span id="tcur">0:00</span> / <span id="tlen">${this.fmt(total)}</span></div>
          </div>
          <div class="bar"><div class="fill" id="fill"></div></div>
          <div class="row">
            <div class="controls">
              <button class="btn" id="playPause">Play</button>
              <button class="btn" id="replay">Replay</button>
            </div>
            <div class="time" id="status">Ready</div>
          </div>`;
        return ui;
      }
      
      closeViewerAuto() {
        this.innerWindow.classList.remove('active');
        this.viewer.innerHTML = '';
        if (!this.audio.paused) this.audio.pause();
        this.seg.active = false;
        cancelAnimationFrame(this.seg.rafId);
      }
      
      onSegmentComplete(id) {
        if (!this.done.has(id)) {
          this.done.add(id);
          this.saveDone();
          this.applyStates();
        }
        this.closeViewerAuto();
      }
      
      wireAudioSegment(startSec, endSec, id) {
        const total = endSec - startSec;
        this.seg = { start: startSec, end: endSec, active: true, currentId: id };
        
        const fill = document.getElementById('fill');
        const playPause = document.getElementById('playPause');
        const replay = document.getElementById('replay');
        const status = document.getElementById('status');
        const tcur = document.getElementById('tcur');
        
        const syncUI = () => {
          if (!this.seg.active) return;
          const now = Math.min(Math.max(this.audio.currentTime, this.seg.start), this.seg.end);
          const elapsed = now - this.seg.start;
          fill.style.width = `${(elapsed / total) * 100}%`;
          tcur.textContent = this.fmt(elapsed);
          if (now >= this.seg.end - 0.02) {
            this.audio.pause();
            playPause.textContent = 'Play';
            status.textContent = 'Finished';
            cancelAnimationFrame(this.seg.rafId);
            this.onSegmentComplete(id);
            return;
          }
          this.seg.rafId = requestAnimationFrame(syncUI);
        };
        
        const startSeg = () => {
          this.audio.currentTime = this.seg.start;
          this.audio.play().then(() => {
            playPause.textContent = 'Pause';
            status.textContent = 'Playing';
            cancelAnimationFrame(this.seg.rafId);
            this.seg.rafId = requestAnimationFrame(syncUI);
          }).catch(() => {
            status.textContent = 'Tap Play to start audio';
          });
        };
        
        this.audio.ontimeupdate = () => {
          if (!this.seg.active) return;
          if (this.audio.currentTime < this.seg.start) this.audio.currentTime = this.seg.start;
          if (this.audio.currentTime > this.seg.end) this.audio.currentTime = this.seg.end;
        };
        
        playPause.onclick = () => {
          if (this.audio.paused) {
            if (this.audio.currentTime <= this.seg.start || this.audio.currentTime >= this.seg.end) {
              startSeg();
            } else {
              this.audio.play().then(() => {
                playPause.textContent = 'Pause';
                status.textContent = 'Playing';
                cancelAnimationFrame(this.seg.rafId);
                this.seg.rafId = requestAnimationFrame(syncUI);
              });
            }
          } else {
            this.audio.pause();
            playPause.textContent = 'Play';
            status.textContent = 'Paused';
          }
        };
        
        replay.onclick = () => startSeg();
        
        startSeg();
      }
      
      getTitleAndBody(text) {
        const m = text.match(/^\s*\[([^\]]+)\]\s*\n?([\s\S]*)$/);
        return m ? { title: m[1], body: (m[2] || '').trimStart() } : { title: 'Narration', body: text };
      }
      
      openFor(button) {
        const id = button.id;
        const s = this.tcToSeconds(button.dataset.tcStart);
        const e = this.tcToSeconds(button.dataset.tcEnd);
        const subsRaw = this.config.subtitles[id] || '';
        const { title, body } = this.getTitleAndBody(subsRaw);
        const mediaList = Array.isArray(this.config.media[id]) ? this.config.media[id] : [];
        const hasMedia = mediaList.length > 0;
        
        this.innerWindow.classList.remove('small', 'large');
        this.viewer.innerHTML = '';
        this.viewerTitle.textContent = title || 'Narration';
        
        if (hasMedia) {
          this.innerWindow.classList.add('large');
          const mediaArea = document.createElement('div');
          mediaArea.className = 'mediaArea';
          
          const file = mediaList[0];
          if (/\.(mp4|mov|webm|m4v)$/i.test(file)) {
            const v = document.createElement('video');
            v.src = file;
            v.autoplay = true;
            v.muted = true;
            v.playsInline = true;
            v.loop = false;
            v.controls = false;
            mediaArea.appendChild(v);
          } else {
            const img = document.createElement('img');
            img.src = file;
            img.alt = title || 'Visual';
            mediaArea.appendChild(img);
          }
          
          const caption = document.createElement('div');
          caption.className = 'caption';
          caption.textContent = body;
          mediaArea.appendChild(caption);
          this.viewer.appendChild(mediaArea);
          this.viewer.appendChild(this.buildAudioUI(e - s));
        } else {
          this.innerWindow.classList.add('small');
          const wrap = document.createElement('div');
          wrap.className = 'subs-only';
          const text = document.createElement('div');
          text.className = 'subs-text';
          text.textContent = body;
          wrap.appendChild(text);
          wrap.appendChild(this.buildAudioUI(e - s));
          this.viewer.appendChild(wrap);
        }
        
        this.innerWindow.classList.add('active');
        this.wireAudioSegment(s, e, id);
      }
    }
    
    // Initialize the training system
    new ModularTrainingSystem(CONFIG);
  </script>
</body>
</html>