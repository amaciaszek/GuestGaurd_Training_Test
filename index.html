<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Training Module</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --stage-max-width:1200px;
      --bg:#0e0e12; 
      --active:#f8fafc; 
      --completed:#0b242c; 
      --locked:#4a4a4a;
      --badge-offset: 2px;
      --badge-size: 20px;
    }
    *{box-sizing:border-box}
    body{ margin:0;min-height:100svh;display:grid;place-items:center;
      background:var(--bg);color:#e9eef5;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; }
    .frame{ width:min(95vw,var(--stage-max-width)); border-radius:28px;border:2px solid rgba(255,255,255,.12);
      box-shadow:0 20px 60px rgba(0,0,0,.55), inset 0 0 0 1px rgba(255,255,255,.04); overflow:hidden;background:#11151a; }
    .titlebar{ padding:14px 18px;border-bottom:1px solid rgba(255,255,255,.08); font-weight:600;letter-spacing:.2px;
      background:linear-gradient(180deg,rgba(255,255,255,.05),transparent); }
    .stage{ position:relative;width:100%;aspect-ratio:6000/4000; background:center / 100% 100% no-repeat; }

    .hotspot{ position:absolute;display:grid;place-items:center; transform:translate(-50%,-50%);cursor:pointer;
      font-weight:800;color:#333;font-size:14px;letter-spacing:.6px; border:3px solid transparent;
      transition:transform .2s ease, opacity .2s ease, background .2s ease, border-color .2s ease, box-shadow .2s ease; }
    .hotspot.circle{ border-radius:50%; } 
    .hotspot.oval{ border-radius:9999px; padding:6px 16px; }
    .hotspot.pill{ position:absolute; transform:none; border-radius:9999px; padding:10px 18px; font-size:16px; }
    .hotspot:not(.pill){font-size:0; line-height:0;}
    .hotspot.locked{ pointer-events:none; opacity:0.3; background:rgba(74,74,74,0.3); border-color:var(--locked); }
    .hotspot.clickable{ pointer-events:auto; background:rgba(248,250,252,0.2); border-color:#333; animation:megaPulse 1.1s ease-in-out infinite; }
    .hotspot.clickable:hover{ transform:translate(-50%,-50%) scale(1.05); }
    .hotspot.pill.clickable{ background:var(--active); }
    .hotspot.pill.clickable:hover{ transform:none; }
    .hotspot.done{ pointer-events:auto; background:rgba(11,36,44,0.3); border-color:#fff; color:#fff; box-shadow:0 0 0 3px rgba(11,36,44,.5); }
    .hotspot.pill.done{ background:var(--completed); }

    .hotspot::before{
      content: attr(data-number);
      position: absolute;
      top: var(--badge-offset);
      left: var(--badge-offset);
      width: var(--badge-size);
      height: var(--badge-size);
      display: grid;
      place-items: center;
      background:#333; color:#fff; border-radius:50%;
      font-size:12px; font-weight:700; z-index:2; pointer-events:none;
    }
    .hotspot.done::after{
      content: '✓';
      position: absolute;
      top: var(--badge-offset); right: var(--badge-offset);
      width: var(--badge-size); height: var(--badge-size);
      display: grid; place-items:center;
      background:#22c55e; color:#fff; border-radius:50%;
      font-size:12px; font-weight:700; z-index:2; pointer-events:none;
    }
    .hotspot.pill::before{ top:-2px; left:-2px }
    .hotspot.pill.done::after{ top:-2px; right:-2px }

    @keyframes megaPulse{ 
      0%{box-shadow:0 0 0 0 rgba(248,250,252,.8), 0 0 20px 4px rgba(248,250,252,.6)}
      50%{box-shadow:0 0 0 12px rgba(248,250,252,0), 0 0 35px 12px rgba(248,250,252,.9)}
      100%{box-shadow:0 0 0 0 rgba(248,250,252,0), 0 0 20px 4px rgba(248,250,252,.6)} 
    }

    .inner-window{ position:absolute;display:none;flex-direction:column;z-index:20;background:#000;border-radius:16px;
      box-shadow:0 0 40px rgba(0,0,0,.8);overflow:hidden; }
    .inner-window.active{display:flex}
    .inner-window.large{ top:8%; left:8%; width:84%; height:84%; }
    .inner-window.small{ right:3%; bottom:6%; width:min(520px, 46%); max-height:60%; }

    .inner-window header{ background:#1a1a1a;color:#fff;padding:10px 12px;font-weight:700;
      display:flex;justify-content:space-between;align-items:center;gap:8px; }
    .inner-window header .right{display:flex;gap:8px;align-items:center}
    .header-real-life-btn{ background:rgba(0,0,0,.8); color:#fff; border:2px solid #00e0ff; border-radius:8px; padding:8px 12px; font-size:14px; cursor:pointer; transition:all .2s ease; }
    .header-real-life-btn:hover{ background:rgba(0,224,255,.2); }

    .viewer{ flex:1; display:flex; flex-direction:column; gap:12px; align-items:stretch; padding:12px; background:#000; height:100%; min-height:0; }
    .mediaArea{ position:relative; flex:1; min-height:0; display:grid; place-items:center; overflow:hidden; border-radius:10px; background:#000; }
    .mediaArea video, .mediaArea img{ max-width:100%; max-height:100%; width:100%; height:100%; object-fit:contain; border-radius:8px; }
    .caption{ position:absolute; left:12px; right:auto; bottom:12px; display:inline-block; width:fit-content; max-width:calc(100% - 24px); background:rgba(0,0,0,.65); color:#fff; padding:10px 12px; border-radius:10px; font-size:16px; line-height:1.35; pointer-events:none; z-index:2; white-space:pre-wrap; overflow-wrap:anywhere; }

    .audio-ui{ flex:0 0 auto; width:100%; display:grid; gap:10px; }
    .row{display:flex;align-items:center;gap:10px;justify-content:space-between}
    .biglabel{font-weight:700}
    .controls{display:flex;gap:10px;flex-wrap:wrap}
    .btn{ background:#2a2a2a;color:#fff;border:1px solid rgba(255,255,255,.2); padding:8px 12px;border-radius:8px;cursor:pointer; font-size:16px; display:flex; align-items:center; justify-content:center; min-width:40px; }
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .btn[title]:hover::after{ content:attr(title); position:absolute; bottom:120%; left:50%; transform:translateX(-50%); background:#333; color:#fff; padding:4px 8px; border-radius:4px; font-size:12px; white-space:nowrap; z-index:100; }
    .bar{ position:relative;height:14px;border-radius:9999px;overflow:hidden; background:linear-gradient(90deg, rgba(255,255,255,.12), rgba(255,255,255,.06)); border:1px solid rgba(255,255,255,.2); pointer-events:none; }
    .fill{ position:absolute;inset:0 auto 0 0;width:0%; background:linear-gradient(90deg, #00e0ff, #22c55e); box-shadow:0 0 10px rgba(0,224,255,.9); }
    .time{font-variant-numeric:tabular-nums}

    .viewer-actions{ display:flex; gap:12px; align-items:center; justify-content:flex-end; padding-top:12px; }
    .next-btn{ background:#00e0ff; color:#000; border:none; padding:10px 20px; border-radius:8px; font-weight:600; cursor:pointer; transition:all .2s ease; }
    .next-btn:hover{ background:#22c55e; }
    .close-btn{ background:#666; color:#fff; border:none; padding:10px 16px; border-radius:8px; cursor:pointer; }

    .chapter-complete-overlay{ position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.8); backdrop-filter:blur(4px); z-index:9998; }
    .chapter-complete-dialog{ background:#0f1216; border:1px solid rgba(255,255,255,.15); border-radius:16px; padding:24px; width:min(480px,90vw); box-shadow:0 20px 60px rgba(0,0,0,.7); text-align:center; }
    .chapter-complete-dialog h2{ margin:0 0 16px 0; font-size:24px; color:#22c55e; }
    .chapter-complete-dialog p{ margin:0 0 20px 0; color:#cfd7e3; line-height:1.5; }
    .chapter-complete-dialog .actions{ display:flex; gap:12px; justify-content:center; }
    .chapter-complete-dialog .btn{ background:#2a2a2a; color:#fff; border:1px solid rgba(255,255,255,.2); padding:12px 20px; border-radius:10px; cursor:pointer; font-weight:600; transition:background .2s ease; }
    .chapter-complete-dialog .btn.primary{ background:#00e0ff; color:#000; }
    .chapter-complete-dialog .btn:hover{ background:#3a3a3a; }
    .chapter-complete-dialog .btn.primary:hover{ background:#22c55e; }

    .startup {
      position: fixed; inset: 0; display:none; place-items: center;
      background: rgba(0,0,0,.7); backdrop-filter: blur(2px); z-index: 9999;
    }
    .startup .panel {
      background: #0f1216; border: 1px solid rgba(255,255,255,.15); border-radius: 16px;
      padding: 20px; width: min(520px, 92vw); box-shadow: 0 20px 60px rgba(0,0,0,.6);
    }
    .startup h1 { margin: 0 0 8px 0; font-size: 18px; letter-spacing: .2px; }
    .startup p { margin: 0 0 14px 0; color:#cfd7e3; font-size:14px; }
    .startup .actions { display:flex; gap:10px; flex-wrap:wrap; }
    .startup .actions .btn { background:#2a2a2a;color:#fff;border:1px solid rgba(255,255,255,.2);
      padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600; }
    .startup .hint { font-size:12px; opacity:.85; margin-top:10px; color:#99a3b3; }
    .startup .drop { margin-top:12px; padding:14px; border:1px dashed rgba(255,255,255,.25); border-radius:12px;
      text-align:center; color:#cfd7e3; font-size:13px; }
    .startup .drop.dragover { background: rgba(255,255,255,.06); }
    input[type="file"]#configPicker { display:none; }
  </style>
</head>
<body>
  <main class="frame" role="main" aria-label="Training Module">
    <div class="titlebar" id="moduleTitle">Loading…</div>
    <section class="stage" aria-label="Main visual with hotspots" id="stage">
      <div id="innerWindow" class="inner-window" aria-modal="true" role="dialog" aria-label="Content viewer">
        <header>
          <span id="viewerTitle">Narration</span>
          <div class="right"><button id="closeViewer" class="btn" title="Close">×</button></div>
        </header>
        <div id="viewer" class="viewer"></div>
      </div>
      <audio id="vo" preload="metadata"></audio>
    </section>
  </main>

  <div id="startup" class="startup" aria-modal="true" role="dialog">
    <div class="panel" id="panel">
      <h1>Select a module JSON</h1>
      <p>Choose a config file, drag & drop, or load via <code>?config=URL</code>.</p>
      <div class="actions">
        <button id="pickBtn" class="btn">Choose config JSON</button>
      </div>
      <div id="drop" class="drop" aria-label="Drop JSON here">Drop JSON here</div>
      <div class="hint" id="hint"></div>
    </div>
  </div>
  <input id="configPicker" type="file" accept=".json,application/json" />

  <script>
  "use strict";

  const LocalDebugMode = false;
  const MODULE_SEQUENCE = ['2-1.json','2-2.json','2-3.json'];

  const fmt = (t)=>`${Math.floor(t/60)}:${Math.floor(t%60).toString().padStart(2,'0')}`;
  const tcToSeconds = (tc, FPS=30)=>{
    const parts = String(tc||'0:0:0:0').split(/[;:]/).map(n=>parseInt(n,10)||0);
    const [hh,mm,ss,ff]=[parts[0]||0,parts[1]||0,parts[2]||0,parts[3]||0];
    return hh*3600+mm*60+ss+(ff/FPS);
  };
  function el(tag, attrs={}, children=[]){
    const n = document.createElement(tag);
    for (const [k,v] of Object.entries(attrs)){
      if (k === 'class') n.className = v;
      else if (k === 'style') n.style.cssText = v;
      else if (k.startsWith('on') && typeof v === 'function') n.addEventListener(k.substring(2), v);
      else n.setAttribute(k, v);
    }
    (Array.isArray(children)?children:[children]).forEach(c=>{
      if (c==null) return;
      if (typeof c === 'string') n.appendChild(document.createTextNode(c));
      else n.appendChild(c);
    });
    return n;
  }
  const isAbsoluteUrl = (p)=>/^([a-z]+:)?\/\//i.test(p) || p.startsWith('/');

  class ModularTrainingSystem {
    constructor(config, currentModuleIndex=0, modulePath=null){
      this.config = config;
      this.currentModuleIndex = currentModuleIndex;
      this.FPS = 30;
      this.VER_KEY = 'training_schema';
      this.SCHEMA_VERSION = 4;
      this.seg = {start:0,end:0,active:false,rafId:null,currentId:null,currentVideo:null};
      this.realLifeIndex = 0;

      this.moduleUrl = modulePath ? new URL(modulePath, window.location.href) : new URL(window.location.href);
      this.moduleBase = new URL('.', this.moduleUrl).href;

      this.init();
    }

    resolveAsset(p){
      if (!p) return '';
      if (isAbsoluteUrl(p)) return p;
      return new URL(p, this.moduleBase).href;
    }

    init(){
      this.initStorage();
      this.cacheDOM();
      this.applyConfigBasics();
      this.createHotspots();
      this.wireHotspotClicks();
      this.applyStatesLinear();
    }

    initStorage(){
      const currentVer = parseInt(localStorage.getItem(this.VER_KEY)||'0',10);
      if (currentVer !== this.SCHEMA_VERSION){
        Object.keys(localStorage).forEach(k=>{ if (k.endsWith('_done')) localStorage.removeItem(k); });
        localStorage.setItem(this.VER_KEY,String(this.SCHEMA_VERSION));
      }
      this.moduleKey = `${this.config.id||'default'}_done`;
      this.done = new Set(JSON.parse(localStorage.getItem(this.moduleKey)||'[]'));
    }
    saveDone(){ localStorage.setItem(this.moduleKey, JSON.stringify([...this.done])); }

    cacheDOM(){
      this.title = document.getElementById('moduleTitle');
      this.stage = document.getElementById('stage');
      this.innerWindow = document.getElementById('innerWindow');
      this.viewer = document.getElementById('viewer');
      this.viewerTitle = document.getElementById('viewerTitle');
      this.audio = document.getElementById('vo');
      this.closeViewerBtn = document.getElementById('closeViewer');
      this.closeViewerBtn.addEventListener('click', ()=>this.closeViewer());
    }

    applyConfigBasics(){
      document.title = this.config.title || 'Training Module';
      this.title.textContent = this.config.title || 'Training Module';

      const bg = this.resolveAsset(this.config.backgroundImage || '');
      if (bg){
        const img = new Image();
        const withBust = bg + (bg.includes('?') ? '&' : '?') + 'v=' + Date.now();
        img.onload = ()=>{ this.stage.style.backgroundImage = `url('${withBust}')`; };
        img.onerror = ()=>{ this.stage.style.backgroundImage = `url('${bg}')`; };
        img.src = withBust;
      } else {
        this.stage.style.backgroundImage = '';
      }

      const audioSrc = this.resolveAsset(this.config.audioFile || '');
      if (audioSrc) {
        this.audio.src = audioSrc;
        this.audio.addEventListener('error', (e) => console.error('Audio error:', e, this.audio.error));
      } else {
        this.audio.removeAttribute('src');
      }
    }

    createHotspots(){
      const W = this.config.canvasDimensions?.width || 6000;
      const H = this.config.canvasDimensions?.height || 4000;
      this.linearOrder = [];
      let visualIndex = 0;

      (this.config.hotspots||[]).forEach((h, idx)=>{
        const b = el('button',{id:h.id, class:'hotspot', 'data-id':h.id, 'data-tcStart':h.tcStart||'00:00:00:00', 'data-tcEnd':h.tcEnd||'00:00:00:01', 'data-order':h.order||''});
        visualIndex += 1;
        b.setAttribute('data-number', String(visualIndex));

        const isFirst = idx===0;
        const isDone = (h.order||'').toLowerCase()==='done';
        const isPill = isFirst || h.type==='pill' || isDone;

        if (isPill){
          b.classList.add('pill');
          const label = isFirst ? 'Start' : (h.label ?? (isDone ? 'Done' : (h.text || 'Action')));
          b.textContent = label;
          b.setAttribute('aria-label', label);
          if (isFirst) b.style.cssText = 'left:3%; bottom:5%; right:auto; top:auto; transform:none;';
          else if (isDone) b.style.cssText = 'right:3%; bottom:5%; left:auto; top:auto; transform:none;';
          else {
            const dock = (h.dock||'right').toLowerCase();
            b.style.cssText = (dock==='left') ? 'left:3%; bottom:5%; right:auto; top:auto; transform:none;' : 'right:3%; bottom:5%; left:auto; top:auto; transform:none;';
          }
        } else {
          b.classList.add(h.type||'circle');
          const leftPct   = (h.centerX/W)*100;
          const topPct    = (h.centerY/H)*100;
          const widthPct  = (h.width/W)*100;
          const heightPct = (h.height/H)*100;
          b.style.cssText = `left:${leftPct}%;top:${topPct}%;width:${widthPct}%;height:${heightPct}%;`;
        }

        this.stage.appendChild(b);
        this.linearOrder.push(h.id);
      });

      this.buttons = {};
      (this.config.hotspots||[]).forEach(h=>{ this.buttons[h.id] = document.getElementById(h.id); });
    }

    wireHotspotClicks(){
      (this.config.hotspots||[]).forEach(h=>{
        const b = this.buttons[h.id];
        if (!b) return;
        b.addEventListener('click', ()=>{
          if (b.classList.contains('locked')) return;
          this.openFor(b);
        });
      });
    }

    setState(el, state){
      el.classList.remove('clickable','locked','done');
      el.classList.add(state);
      el.setAttribute('aria-disabled', state==='locked' ? 'true' : 'false');
    }

    applyStatesLinear(){
      this.linearOrder.forEach(id=>this.setState(this.buttons[id], 'locked'));
      let unlockedOne = false;
      this.linearOrder.forEach(id=>{
        if (this.done.has(id)) this.setState(this.buttons[id],'done');
        else if (!unlockedOne){ this.setState(this.buttons[id],'clickable'); unlockedOne=true; }
      });
    }

    buildAudioUI(total){
      const ui = el('div',{class:'audio-ui'},[
        el('div',{class:'row'},[
          el('div',{class:'biglabel'},'Narration'),
          el('div',{class:'time'},[
            el('span',{id:'tcur'},'0:00'),' / ', el('span',{id:'tlen'},fmt(total))
          ])
        ]),
        el('div',{class:'bar'}, el('div',{class:'fill', id:'fill'})),
        el('div',{class:'row'},[
          el('div',{class:'controls'},[
            el('button',{class:'btn',id:'playPause',title:'Play/Pause'},'▶'),
            el('button',{class:'btn',id:'replay',title:'Replay'},'⟳'),
          ]),
          el('div',{class:'viewer-actions'},[
            el('span',{class:'time',id:'status'},'Ready'),
            el('button',{class:'close-btn',id:'closeBtn'},'Close'),
            el('button',{class:'next-btn',id:'nextBtn',style:'display:none'},'Next'),
          ])
        ])
      ]);
      return ui;
    }

    pauseViewer(){
      if (this.seg.currentVideo) this.seg.currentVideo.pause();
      if (!this.audio.paused) this.audio.pause();
      const playPause = document.getElementById('playPause');
      const status = document.getElementById('status');
      if (playPause) playPause.textContent='▶';
      if (status) status.textContent='Paused';
    }

    closeViewer(){
      this.innerWindow.classList.remove('active');
      this.viewer.replaceChildren();
      if (this.seg.currentVideo){ this.seg.currentVideo.pause(); this.seg.currentVideo=null; }
      if (!this.audio.paused) this.audio.pause();
      this.seg.active=false; cancelAnimationFrame(this.seg.rafId);
    }

    showChapterCompleteDialog(){
      let overlay = document.querySelector('.chapter-complete-overlay');
      if (!overlay){
        overlay = el('div',{class:'chapter-complete-overlay'}, el('div',{class:'chapter-complete-dialog'},[
          el('h2',{},'Chapter Complete!'),
          el('p',{},'You\'ve finished this chapter of the training module. Would you like to continue to the next chapter?'),
          el('div',{class:'actions'},[
            el('button',{class:'btn',id:'stayBtn'},'Stay Here'),
            el('button',{class:'btn primary',id:'continueBtn'},'Continue to Next Chapter')
          ])
        ]));
        document.body.appendChild(overlay);
      }
      overlay.style.display='grid';
      overlay.querySelector('#stayBtn').onclick = ()=>{ overlay.style.display='none'; this.closeViewer(); };
      overlay.querySelector('#continueBtn').onclick = ()=>{ overlay.style.display='none'; this.loadNextModule(); };
    }

    loadNextModule(){
      const nextIndex = this.currentModuleIndex + 1;
      if (nextIndex >= MODULE_SEQUENCE.length){
        alert('Congratulations! You have completed all training modules.');
        return;
      }
      loadModule(MODULE_SEQUENCE[nextIndex], nextIndex);
    }

    onSegmentComplete(id){
      if (!this.done.has(id)){ this.done.add(id); this.saveDone(); this.applyStatesLinear(); }
      const hotspot = (this.config.hotspots||[]).find(h=>h.id===id);
      const isDone = (hotspot?.order||'').toLowerCase()==='done';
      const nextBtn = document.getElementById('nextBtn');
      if (nextBtn){
        nextBtn.style.display='block';
        nextBtn.onclick = ()=>{
          if (isDone){
            const isLast = this.currentModuleIndex === MODULE_SEQUENCE.length - 1;
            if (isLast){ alert('Congratulations! You have completed all training modules.'); this.closeViewer(); }
            else { this.showChapterCompleteDialog(); }
          } else {
            this.closeViewer();
          }
        };
      }
    }

    wireAudioSegment(startSec,endSec,id){
      const total = Math.max(0.01, endSec-startSec);
      this.seg = {start:startSec,end:endSec,active:true,currentId:id,currentVideo:this.seg.currentVideo,rafId:null};
      
      const fill = document.getElementById('fill');
      const playPause = document.getElementById('playPause');
      const replay = document.getElementById('replay');
      const status = document.getElementById('status');
      const tcur = document.getElementById('tcur');
      const closeBtn = document.getElementById('closeBtn');

      const syncUI = ()=>{
        if (!this.seg.active) return;
        const now = Math.min(Math.max(this.audio.currentTime, this.seg.start), this.seg.end);
        const elapsed = now - this.seg.start;
        if (fill) fill.style.width = `${(elapsed/total)*100}%`;
        if (tcur) tcur.textContent = fmt(elapsed);
        if (now >= this.seg.end - 0.02){
          this.audio.pause();
          if (this.seg.currentVideo) this.seg.currentVideo.pause();
          if (playPause) playPause.textContent='▶';
          if (status) status.textContent='Finished';
          cancelAnimationFrame(this.seg.rafId);
          this.onSegmentComplete(id);
          return;
        }
        this.seg.rafId = requestAnimationFrame(syncUI);
      };

      const startSeg = ()=>{
        this.audio.currentTime = startSec;
        this.audio.play().then(()=>{
          if (this.seg.currentVideo){ 
            this.seg.currentVideo.play().catch(()=>{}); 
          }
          if (playPause) playPause.textContent='❚❚';
          if (status) status.textContent='Playing';
          cancelAnimationFrame(this.seg.rafId);
          this.seg.rafId = requestAnimationFrame(syncUI);
        }).catch(()=>{
          if (status) status.textContent='Tap Play to start audio';
        });
      };

      this.audio.ontimeupdate = ()=>{
        if (!this.seg.active) return;
        if (this.audio.currentTime < this.seg.start) this.audio.currentTime = this.seg.start;
        if (this.audio.currentTime > this.seg.end) this.audio.currentTime = this.seg.end;
      };

      if (playPause){
        playPause.onclick = ()=>{
          if (this.audio.paused){
            if (this.audio.currentTime <= this.seg.start || this.audio.currentTime >= this.seg.end){ 
              startSeg(); 
            } else {
              this.audio.play().then(()=>{
                if (this.seg.currentVideo) this.seg.currentVideo.play().catch(()=>{});
                playPause.textContent='❚❚';
                if (status) status.textContent='Playing';
                cancelAnimationFrame(this.seg.rafId);
                this.seg.rafId = requestAnimationFrame(syncUI);
              });
            }
          } else {
            this.audio.pause();
            if (this.seg.currentVideo) this.seg.currentVideo.pause();
            playPause.textContent='▶';
            if (status) status.textContent='Paused';
          }
        };
      }
      if (replay) replay.onclick = ()=> startSeg();
      if (closeBtn) closeBtn.onclick = ()=>this.closeViewer();
      startSeg();
    }

    getTitleAndBody(text){
      const m = (text||'').match(/^\s*\[([^\]]+)\]\s*\n?([\s\S]*)$/);
      return m ? { title:m[1], body:(m[2]||'').trimStart() } : { title:'Narration', body:text||'' };
    }

    openFor(button){
      const id = button.id;
      const h = (this.config.hotspots||[]).find(x=>x.id===id) || {};
      const s = tcToSeconds(h.tcStart, this.FPS);
      const e = tcToSeconds(h.tcEnd, this.FPS);
      const {title, body} = this.getTitleAndBody(h.content || h.text || '');

      this.viewer.replaceChildren();
      this.viewerTitle.textContent = title || 'Narration';
      this.innerWindow.classList.remove('small','large');

      const hasVideo = h.video || (h.contentMedia && h.contentMedia.type === 'video');
      const hasImage = h.contentMedia && h.contentMedia.type === 'image';
      
      if (hasVideo || hasImage){
        this.innerWindow.classList.add('large');
        const media = el('div',{class:'mediaArea'});
        
        if (hasVideo) {
          const videoSrc = h.video ? this.resolveAsset(h.video) : this.resolveAsset(h.contentMedia.src);
          const vid = el('video',{src:videoSrc});
          vid.autoplay = true; vid.muted = true; vid.playsInline = true; vid.loop = true; vid.controls = false;
          vid.addEventListener('loadedmetadata',()=>{ vid.play().catch(()=>{}); });
          media.appendChild(vid);
          this.seg.currentVideo = vid;
        } else if (hasImage) {
          const imgSrc = this.resolveAsset(h.contentMedia.src);
          const img = el('img',{src:imgSrc, alt: h.contentMedia.alt || 'Content image'});
          media.appendChild(img);
        }
        
        media.appendChild(el('div',{class:'caption'},body));
        this.viewer.appendChild(media);
      } else {
        this.innerWindow.classList.add('small');
        const wrap = el('div',{class:'subs-only'});
        wrap.appendChild(el('div',{class:'subs-text'}, body));
        this.viewer.appendChild(wrap);
      }

      const right = this.innerWindow.querySelector('header .right');
      right.querySelectorAll('.header-real-life-btn').forEach(btn => btn.remove());
      if (Array.isArray(h.realLifeExamples) && h.realLifeExamples.length){
        const btn = el('button',{class:'header-real-life-btn'},'Real Life Example');
        const imgs = h.realLifeExamples.map(p=>this.resolveAsset(p));
        btn.onclick = ()=>this.showRealLifePopup(imgs);
        right.insertBefore(btn, right.firstChild);
      }

      this.viewer.appendChild(this.buildAudioUI(Math.max(0.01, e - s)));
      this.innerWindow.classList.add('active');
      this.wireAudioSegment(s, e, id);

      this.stage.onclick = (ev)=>{
        if (ev.target === this.stage) this.pauseViewer();
      };
    }

    showRealLifePopup(examples){
      const imgs = Array.isArray(examples) ? examples.slice() : [];
      if (!imgs.length) return;

      const existing = document.getElementById('realLifePopup');
      if (existing) existing.remove();

      let idx = 0;

      const overlay = el('div', {
        id:'realLifePopup',
        style:[
          'position:fixed','inset:0','display:grid','place-items:center',
          'background:rgba(0,0,0,.7)','z-index:9999'
        ].join(';')
      });

      const shell = el('div', {
        style:[
          'position:relative',
          'background:#0f1216','border:1px solid rgba(255,255,255,.2)','border-radius:12px',
          'max-width:min(90vw,800px)','max-height:min(90vh,600px)',
          'width:clamp(320px,80vw,800px)','height:clamp(240px,70vh,600px)',
          'display:flex','flex-direction:column','overflow:hidden'
        ].join(';')
      });

      const floatClose = el('button', {
        'aria-label':'Close',
        style:[
          'position:absolute','top:8px','right:8px','z-index:3',
          'background:#ff4444','color:#fff','border:none',
          'padding:6px 10px','border-radius:10px','cursor:pointer',
          'font-weight:800','font-size:16px','line-height:1'
        ].join(';')
      }, '✕');

      const header = el('header', {
        style:'background:#1a1a1a;color:#fff;padding:10px 12px;display:flex;justify-content:center;align-items:center;font-weight:700'
      }, 'Real Life Example');

      const stage = el('div', {
        style:'flex:1;display:flex;align-items:center;justify-content:center;padding:12px;background:#000;min-height:0'
      });

      const img = el('img', {
        id:'realLifeImg',
        alt:'Real life example',
        style:'max-width:100%;max-height:100%;object-fit:contain'
      });

      const footer = el('div', {
        style:'display:flex;gap:12px;justify-content:space-between;align-items:center;padding:10px 12px;background:#0f1216;border-top:1px solid rgba(255,255,255,.12)'
      });

      const prevBtn = el('button', { class:'btn', type:'button', style:'min-width:96px' }, '‹ Previous');
      const counter = el('span', { id:'counter', style:'color:#e9eef5' });
      const nextBtn = el('button', { class:'btn', type:'button', style:'min-width:96px' }, 'Next ›');

      stage.appendChild(img);
      footer.appendChild(prevBtn);
      footer.appendChild(counter);
      footer.appendChild(nextBtn);
      shell.appendChild(floatClose);
      shell.appendChild(header);
      shell.appendChild(stage);
      if (imgs.length > 1) shell.appendChild(footer);
      overlay.appendChild(shell);
      document.body.appendChild(overlay);

      const setDisabled = (el, on)=>{ el.disabled = !!on; el.style.opacity = on ? '.5' : '1'; };

      const render = ()=>{
        img.src = imgs[idx];
        counter.textContent = `${idx+1} of ${imgs.length}`;
        if (imgs.length > 1){
          setDisabled(prevBtn, idx === 0);
          setDisabled(nextBtn, idx === imgs.length - 1);
        }
      };

      const goPrev = ()=>{ if (idx > 0){ idx--; render(); } };
      const goNext = ()=>{ if (idx < imgs.length - 1){ idx++; render(); } };

      floatClose.onclick = ()=> overlay.remove();
      overlay.onclick = (e)=>{ if (e.target === overlay) overlay.remove(); };
      if (imgs.length > 1){
        prevBtn.onclick = goPrev;
        nextBtn.onclick = goNext;
      }

      const onKey = (e)=>{
        if (e.key === 'Escape'){ overlay.remove(); }
        else if (e.key === 'ArrowLeft' && imgs.length > 1){ goPrev(); }
        else if (e.key === 'ArrowRight' && imgs.length > 1){ goNext(); }
      };
      document.addEventListener('keydown', onKey);

      const mo = new MutationObserver(()=>{
        if (!document.getElementById('realLifePopup')) document.removeEventListener('keydown', onKey);
      });
      mo.observe(document.body, { childList:true });

      render();
    }
  }

  function resetStageShell(){
    const stage = document.getElementById('stage');
    stage.replaceChildren(
      el('div',{id:'innerWindow',class:'inner-window','aria-modal':'true',role:'dialog','aria-label':'Content viewer'},[
        el('header',{},[
          el('span',{id:'viewerTitle'},'Narration'),
          el('div',{class:'right'}, el('button',{id:'closeViewer',class:'btn',title:'Close'},'×'))
        ]),
        el('div',{id:'viewer',class:'viewer'})
      ]),
      el('audio',{id:'vo',preload:'metadata'})
    );
  }

  function loadModule(path, idx){
    document.getElementById('moduleTitle').textContent = 'Loading…';
    fetch(path)
      .then(r=>{ if(!r.ok) throw new Error(`${r.status} ${r.statusText}`); return r.json(); })
      .then(cfg=>{
        resetStageShell();
        new ModularTrainingSystem(cfg, idx, path);
      })
      .catch(err=>{
        console.error('Failed to load module:', err);
        alert('Failed to load module: '+ (err?.message || err));
      });
  }

  (function boot(){
    const title = document.getElementById('moduleTitle');

    if (LocalDebugMode){
      const startup = document.getElementById('startup');
      const picker = document.getElementById('configPicker');
      const pickBtn = document.getElementById('pickBtn');
      const drop = document.getElementById('drop');
      const hint = document.getElementById('hint');

      startup.style.display = 'grid';
      title.textContent = 'Select a module JSON…';

      const parseAndInit = (textOrObj, label='') => {
        try{
          const cfg = (typeof textOrObj==='string') ? JSON.parse(textOrObj) : textOrObj;
          startup.remove();
          resetStageShell();
          new ModularTrainingSystem(cfg, 0, window.location.href);
        }catch(e){
          hint.textContent = 'Invalid JSON: ' + (e?.message || e);
        }
      };

      const readFile = (file)=> new Promise((resolve,reject)=>{
        const r = new FileReader();
        r.onload = ()=>resolve(String(r.result));
        r.onerror = ()=>reject(r.error || new Error('Failed to read file'));
        r.readAsText(file, 'utf-8');
      });

      pickBtn.addEventListener('click', ()=>{ picker.value=''; picker.click(); });
      picker.addEventListener('change', async ()=>{
        const f = picker.files && picker.files[0];
        if (!f) return;
        try { parseAndInit(await readFile(f), f.name); }
        catch(e){ hint.textContent = 'Failed to read file: ' + (e?.message || e); }
      });

      ['dragenter','dragover'].forEach(ev=>{
        drop.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); drop.classList.add('dragover'); });
      });
      ['dragleave','drop'].forEach(ev=>{
        drop.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); drop.classList.remove('dragover'); });
      });
      drop.addEventListener('drop', async (e)=>{
        const f = e.dataTransfer.files && e.dataTransfer.files[0];
        if (!f) return;
        try { parseAndInit(await readFile(f), f.name); }
        catch(err){ hint.textContent = 'Failed to read dropped file: ' + (err?.message || err); }
      });

      const params = new URLSearchParams(window.location.search);
      const cfgURL = params.get('config');
      if (cfgURL){
        hint.textContent = 'Loading config from URL…';
        fetch(cfgURL)
          .then(r=>{ if(!r.ok) throw new Error(r.status + ' ' + r.statusText); return r.text(); })
          .then(text=>parseAndInit(text, cfgURL))
          .catch(err=>{ hint.textContent = 'Failed to load ?config: ' + (err?.message || err); });
      } else {
        hint.textContent = 'Pick a JSON file to begin.';
      }

    } else {
      loadModule(MODULE_SEQUENCE[0], 0);
    }
  })();
  </script>
</body>
</html>