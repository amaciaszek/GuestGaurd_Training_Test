<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Training Module</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --stage-max-width:1200px;
      --bg:#0e0e12; 
      --active:#f8fafc; 
      --completed:#0b242c; 
      --locked:#4a4a4a;
      --badge-offset: 2px;
      --badge-size: 20px;
    }
    *{box-sizing:border-box}
    body{ margin:0;min-height:100svh;display:grid;place-items:center;
      background:var(--bg);color:#e9eef5;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; }
    .frame{ width:min(95vw,var(--stage-max-width)); border-radius:28px;border:2px solid rgba(255,255,255,.12);
      box-shadow:0 20px 60px rgba(0,0,0,.55), inset 0 0 0 1px rgba(255,255,255,.04); overflow:hidden;background:#11151a; }
    .titlebar{ padding:14px 18px;border-bottom:1px solid rgba(255,255,255,.08); font-weight:600;letter-spacing:.2px;
      background:linear-gradient(180deg,rgba(255,255,255,.05),transparent); }
    .stage{ position:relative;width:100%;aspect-ratio:6000/4000; background:center / 100% 100% no-repeat; }

    .hotspot{ position:absolute;display:grid;place-items:center; transform:translate(-50%,-50%);cursor:pointer;
      font-weight:800;color:#333;font-size:14px;letter-spacing:.6px; border:3px solid transparent;
      transition:transform .2s ease, opacity .2s ease, background .2s ease, border-color .2s ease, box-shadow .2s ease; }
    .hotspot.circle{ border-radius:50%; } 
    .hotspot.oval{ border-radius:9999px; padding:6px 16px; }
    .hotspot.pill{
      position:absolute;
      transform:none;
      border-radius:9999px;
      padding:10px 18px;
      font-size:16px;
    }
    .hotspot:not(.pill){font-size:0; line-height:0;}
    
    .hotspot.locked{ pointer-events:none; opacity:0.3; background:rgba(74,74,74,0.3); border-color:var(--locked); }
    .hotspot.clickable{ pointer-events:auto; background:rgba(248,250,252,0.2); border-color:#333; animation:megaPulse 1.1s ease-in-out infinite; }
    .hotspot.clickable:hover{ transform:translate(-50%,-50%) scale(1.05); }
    .hotspot.pill.clickable{ background:var(--active); }
    .hotspot.pill.clickable:hover{ transform:none; }
    .hotspot.done{ pointer-events:auto; background:rgba(11,36,44,0.3); border-color:#fff; color:#fff;
      box-shadow:0 0 0 3px rgba(11,36,44,.5); }
    .hotspot.pill.done{ background:var(--completed); }

    .hotspot::before{
      content: attr(data-number);
      position: absolute;
      top: var(--badge-offset);
      left: var(--badge-offset);
      width: var(--badge-size);
      height: var(--badge-size);
      display: grid;
      place-items: center;
      background:#333;
      color:#fff;
      border-radius:50%;
      font-size:12px;
      font-weight:700;
      z-index:2;
      pointer-events:none;
    }

    .hotspot.done::after{
      content: '✓';
      position: absolute;
      top: var(--badge-offset);
      right: var(--badge-offset);
      width: var(--badge-size);
      height: var(--badge-size);
      display: grid;
      place-items:center;
      background:#22c55e;
      color:#fff;
      border-radius:50%;
      font-size:12px;
      font-weight:700;
      z-index:2;
      pointer-events:none;
    }

    .hotspot.pill::before{ top: -2px; left: -2px; }
    .hotspot.pill.done::after{ top: -2px; right: -2px; }

    @keyframes megaPulse{ 
      0%{box-shadow:0 0 0 0 rgba(248,250,252,.8), 0 0 20px 4px rgba(248,250,252,.6);}
      50%{box-shadow:0 0 0 12px rgba(248,250,252,0), 0 0 35px 12px rgba(248,250,252,.9);}
      100%{box-shadow:0 0 0 0 rgba(248,250,252,0), 0 0 20px 4px rgba(248,250,252,.6);} 
    }

    .inner-window{ position:absolute;display:none;flex-direction:column;z-index:20;background:#000;border-radius:16px;
      box-shadow:0 0 40px rgba(0,0,0,.8);overflow:hidden; }
    .inner-window.active{display:flex}
    .inner-window.large{ top:8%; left:8%; width:84%; height:84%; }
    .inner-window.small{ right:3%; bottom:6%; width:min(520px, 46%); max-height:60%; }

    .inner-window header{ background:#1a1a1a;color:#fff;padding:10px 12px;font-weight:700;
      display:flex;justify-content:space-between;align-items:center;gap:8px; }
    .inner-window header .right{display:flex;gap:8px;align-items:center}
    
    .header-real-life-btn{ background:rgba(0,0,0,.8); color:#fff; 
      border:2px solid #00e0ff; border-radius:8px; padding:8px 12px; font-size:14px; cursor:pointer; 
      transition:all .2s ease; }
    .header-real-life-btn:hover{ background:rgba(0,224,255,.2); }

    .viewer{ flex:1; display:flex; flex-direction:column; gap:12px; align-items:stretch;
      padding:12px; background:#000; height:100%; min-height:0; }
    .mediaArea{ position:relative; flex:1; min-height:0; display:grid; place-items:center; overflow:hidden; border-radius:10px; background:#000; }
    .mediaArea video, .mediaArea img{ 
      max-width:100%; 
      max-height:100%; 
      width:100%;
      height:100%;
      object-fit:contain; 
      border-radius:8px;
    }

    .caption{
      position:absolute;
      left:12px;
      right:auto;
      bottom:12px;
      display:inline-block;
      width:fit-content;
      max-width:calc(100% - 24px);
      background:rgba(0,0,0,.65);
      color:#fff;
      padding:10px 12px;
      border-radius:10px;
      font-size:16px;
      line-height:1.35;
      pointer-events:none;
      z-index:2;
      white-space:pre-wrap;
      overflow-wrap:anywhere;
    }

    .real-life-btn{ position:absolute; top:12px; right:12px; background:rgba(0,0,0,.8); color:#fff; 
      border:2px solid #00e0ff; border-radius:8px; padding:8px 12px; font-size:14px; cursor:pointer; 
      transition:all .2s ease; z-index:3; }
    .real-life-btn:hover{ background:rgba(0,224,255,.2); }

    .real-life-popup{ 
      position:absolute; 
      top:50%; 
      left:50%; 
      transform:translate(-50%,-50%); 
      background:#000; 
      border:2px solid #00e0ff; 
      border-radius:12px; 
      max-width:min(90vw, 800px); 
      max-height:min(90vh, 600px); 
      z-index:50; 
      box-shadow:0 0 50px rgba(0,0,0,.9); 
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    
    .real-life-popup header{ 
      background:#1a1a1a; 
      padding:12px; 
      display:flex; 
      justify-content:space-between; 
      align-items:center;
      flex-shrink:0;
    }
    
    .real-life-popup .close-btn{ 
      background:none; 
      border:none; 
      color:#fff; 
      font-size:18px; 
      cursor:pointer; 
      padding:4px 8px;
      border-radius:4px;
      transition:background .2s ease;
    }
    .real-life-popup .close-btn:hover{ background:rgba(255,255,255,.1); }
    
    .real-life-popup .content{ 
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:12px; 
      min-height:0;
      overflow:hidden;
    }
    .real-life-popup img{ 
      max-width:100%; 
      max-height:100%; 
      width:auto;
      height:auto;
      object-fit:contain;
      border-radius:8px;
      display:block;
    }
    
    .real-life-popup .nav{ 
      display:flex; 
      justify-content:space-between; 
      align-items:center;
      padding:0 12px 12px;
      flex-shrink:0;
    }
    
    .real-life-popup .nav button{ 
      background:#2a2a2a; 
      border:1px solid rgba(255,255,255,.3); 
      color:#fff; 
      border-radius:6px; 
      padding:8px 16px; 
      cursor:pointer;
      transition:background .2s ease;
    }
    .real-life-popup .nav button:hover:not(:disabled){ background:#3a3a3a; }
    .real-life-popup .nav button:disabled{ opacity:.5; cursor:not-allowed; }

    .subs-only{ display:flex; flex-direction:column; gap:12px; }
    .subs-text{
      font-size:16px;
      line-height:1.45;
      color:#e9eef5;
      background:#0b0b0b;
      border:1px solid rgba(255,255,255,.15);
      border-radius:12px;
      padding:12px;
      max-height:28vh;
      overflow:auto;
      white-space:pre-wrap; 
      overflow-wrap:anywhere;   
    }

    .inner-window.small .viewer{
      display: grid;
      grid-template-rows: 1fr auto;
    }

    .inner-window.small .subs-only{
      min-height: 0;
      overflow: auto;
    }

    .inner-window.small .subs-text{
      max-height: none;
    }

    .inner-window.small .audio-ui{
      align-self: stretch;
    }

    .audio-ui{ flex:0 0 auto; width:100%; display:grid; gap:10px; }
    .row{display:flex;align-items:center;gap:10px;justify-content:space-between}
    .biglabel{font-weight:700}
    .controls{display:flex;gap:10px;flex-wrap:wrap}
    .btn{ background:#2a2a2a;color:#fff;border:1px solid rgba(255,255,255,.2); padding:8px 12px;border-radius:8px;cursor:pointer; 
      font-size:16px; display:flex; align-items:center; justify-content:center; min-width:40px; }
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .btn[title]:hover::after{ content:attr(title); position:absolute; bottom:120%; left:50%; transform:translateX(-50%); 
      background:#333; color:#fff; padding:4px 8px; border-radius:4px; font-size:12px; white-space:nowrap; z-index:100; }
    .bar{ position:relative;height:14px;border-radius:9999px;overflow:hidden;
      background:linear-gradient(90deg, rgba(255,255,255,.12), rgba(255,255,255,.06)); border:1px solid rgba(255,255,255,.2);
      pointer-events:none; }
    .fill{ position:absolute;inset:0 auto 0 0;width:0%; background:linear-gradient(90deg, #00e0ff, #22c55e); box-shadow:0 0 10px rgba(0,224,255,.9); }
    .time{font-variant-numeric:tabular-nums}

    .viewer-actions{ display:flex; gap:12px; align-items:center; justify-content:flex-end; padding-top:12px; }
    .next-btn{ background:#00e0ff; color:#000; border:none; padding:10px 20px; border-radius:8px; 
      font-weight:600; cursor:pointer; transition:all .2s ease; }
    .next-btn:hover{ background:#22c55e; }
    .close-btn{ background:#666; color:#fff; border:none; padding:10px 16px; border-radius:8px; cursor:pointer; }

    /* Chapter completion dialog */
    .chapter-complete-overlay {
      position: fixed;
      inset: 0;
      display: grid;
      place-items: center;
      background: rgba(0,0,0,.8);
      backdrop-filter: blur(4px);
      z-index: 9998;
    }
    .chapter-complete-dialog {
      background: #0f1216;
      border: 1px solid rgba(255,255,255,.15);
      border-radius: 16px;
      padding: 24px;
      width: min(480px, 90vw);
      box-shadow: 0 20px 60px rgba(0,0,0,.7);
      text-align: center;
    }
    .chapter-complete-dialog h2 {
      margin: 0 0 16px 0;
      font-size: 24px;
      color: #22c55e;
    }
    .chapter-complete-dialog p {
      margin: 0 0 20px 0;
      color: #cfd7e3;
      line-height: 1.5;
    }
    .chapter-complete-dialog .actions {
      display: flex;
      gap: 12px;
      justify-content: center;
    }
    .chapter-complete-dialog .btn {
      background: #2a2a2a;
      color: #fff;
      border: 1px solid rgba(255,255,255,.2);
      padding: 12px 20px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: background .2s ease;
    }
    .chapter-complete-dialog .btn.primary {
      background: #00e0ff;
      color: #000;
    }
    .chapter-complete-dialog .btn:hover {
      background: #3a3a3a;
    }
    .chapter-complete-dialog .btn.primary:hover {
      background: #22c55e;
    }

    /* IMPORTANT: hidden by default, shown only in debug mode */
    .startup {
      position: fixed;
      inset: 0;
      display: none;           /* HIDE BY DEFAULT */
      place-items: center;
      background: rgba(0,0,0,.7);
      backdrop-filter: blur(2px);
      z-index: 9999;
    }
    .startup .panel {
      background: #0f1216;
      border: 1px solid rgba(255,255,255,.15);
      border-radius: 16px;
      padding: 20px;
      width: min(520px, 92vw);
      box-shadow: 0 20px 60px rgba(0,0,0,.6);
    }
    .startup h1 { margin: 0 0 8px 0; font-size: 18px; letter-spacing: .2px; }
    .startup p { margin: 0 0 14px 0; color:#cfd7e3; font-size:14px; }
    .startup .actions { display:flex; gap:10px; flex-wrap:wrap; }
    .startup .actions .btn {
      background:#2a2a2a;color:#fff;border:1px solid rgba(255,255,255,.2);
      padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600;
    }
    .startup .hint { font-size:12px; opacity:.85; margin-top:10px; color:#99a3b3; }
    .startup .drop {
      margin-top:12px;
      padding:14px;
      border:1px dashed rgba(255,255,255,.25);
      border-radius:12px;
      text-align:center;
      color:#cfd7e3;
      font-size:13px;
    }
    .startup .drop.dragover { background: rgba(255,255,255,.06); }
  </style>
</head>
<body>
  <main class="frame" role="main" aria-label="Training Module">
    <div class="titlebar" id="moduleTitle">Loading...</div>

    <section class="stage" aria-label="Main visual with hotspots" id="stage">
      <!-- Hotspots will be generated by JavaScript -->
      <div id="innerWindow" class="inner-window" aria-modal="true" role="dialog" aria-label="Content viewer">
        <header>
          <span id="viewerTitle">Narration</span>
          <div class="right">
            <button id="closeViewer" class="btn" title="Close">×</button>
          </div>
        </header>
        <div id="viewer" class="viewer"></div>
      </div>

      <audio id="vo" preload="metadata"></audio>
    </section>
  </main>

  <!-- Hidden file input for JSON (debug mode only) -->
  <input id="configPicker" type="file" accept=".json,application/json" style="display:none" />

  <!-- Startup overlay (debug only) -->
  <div id="startup" class="startup" aria-modal="true" role="dialog">
    <div class="panel" id="panel">
      <h1>Select your utilities_config.json</h1>
      <p>Pick a config file to start. You can also drag & drop a JSON file onto this box.</p>
      <div class="actions">
        <button id="pickBtn" class="btn">Choose config JSON</button>
      </div>
      <div id="drop" class="drop" aria-label="Drop JSON here">Drop JSON here</div>
      <div class="hint" id="hint"></div>
    </div>
  </div>

  <script>
    // Configuration - set to false for production
    const LocalDebugMode = false;

    // Sequential module configuration
    const MODULE_SEQUENCE = [
      '2-1.json',
      '2-2.json', 
      '2-3.json'
    ];

    class ModularTrainingSystem {
      constructor(config, currentModuleIndex = 0) {
        this.config = config;
        this.currentModuleIndex = currentModuleIndex;
        this.FPS = 30;
        this.STORAGE_KEY = 'training_progress';
        this.VER_KEY = 'training_schema';
        this.SCHEMA_VERSION = 4;
        this.initialize();
      }

      initialize() {
        this.initializeStorage();
        this.setupDOM();
        this.createHotspots();
        this.setupEventListeners();
        this.applyStatesLinear();
        this.seg = {start:0, end:0, active:false, rafId:null, currentId:null, currentVideo:null};
        this.realLifeIndex = 0;
      }

      initializeStorage() {
        const currentVer = parseInt(localStorage.getItem(this.VER_KEY) || '0', 10);
        if (currentVer !== this.SCHEMA_VERSION) {
          Object.keys(localStorage).forEach(k => {
            if (k.endsWith('_done')) localStorage.removeItem(k);
          });
          localStorage.setItem(this.VER_KEY, this.SCHEMA_VERSION);
        }
        const moduleKey = `${this.config.id || 'default'}_done`;
        this.done = new Set(JSON.parse(localStorage.getItem(moduleKey) || '[]'));
        this.moduleKey = moduleKey;
      }

      setupDOM() {
        document.title = this.config.title;
        document.getElementById('moduleTitle').textContent = this.config.title;
        
        this.stage = document.getElementById('stage');
        this.innerWindow = document.getElementById('innerWindow');
        this.viewer = document.getElementById('viewer');
        this.viewerTitle = document.getElementById('viewerTitle');
        this.audio = document.getElementById('vo');
        this.closeViewerBtn = document.getElementById('closeViewer');

        this.setBackgroundImage(this.config.backgroundImage);
        this.audio.src = this.config.audioFile;

        this.closeViewerBtn.addEventListener('click', () => this.closeViewer());
      }

      setBackgroundImage(imagePath) {
        const cacheBuster = '?v=' + Date.now();
        const imageUrl = imagePath + cacheBuster;
        const testImage = new Image();
        testImage.onload = () => { this.stage.style.backgroundImage = `url('${imageUrl}')`; };
        testImage.onerror = () => { this.stage.style.backgroundImage = `url('${imagePath}')`; };
        testImage.src = imageUrl;
      }

      createHotspots() {
        const W = this.config.canvasDimensions.width;
        const H = this.config.canvasDimensions.height;

        this.linearOrder = [];
        let visualIndex = 0;

        this.config.hotspots.forEach((hotspot, idx) => {
          const button = document.createElement('button');
          button.id = hotspot.id;
          button.dataset.id = hotspot.id;
          button.dataset.tcStart = hotspot.tcStart;
          button.dataset.tcEnd = hotspot.tcEnd;
          button.dataset.order = hotspot.order || '';

          const isFirst = idx === 0;
          const isDone = (hotspot.order || '').toLowerCase() === 'done';
          const isPill = isFirst || hotspot.type === 'pill' || isDone;

          visualIndex += 1;
          button.dataset.number = visualIndex;

          if (isPill) {
            button.className = 'hotspot pill';
            const label = isFirst ? 'Start' : (hotspot.label ?? (isDone ? 'Done' : (hotspot.text || 'Action')));
            button.textContent = label;
            button.setAttribute('aria-label', label);
            if (isFirst) {
              button.style.cssText = 'left:3%; bottom:5%; right:auto; top:auto; transform:none;';
            } else if (isDone) {
              button.style.cssText = 'right:3%; bottom:5%; left:auto; top:auto; transform:none;';
            } else {
              const dock = (hotspot.dock || 'right').toLowerCase();
              button.style.cssText =
                (dock === 'left')
                  ? 'left:3%; bottom:5%; right:auto; top:auto; transform:none;'
                  : 'right:3%; bottom:5%; left:auto; top:auto; transform:none;';
            }
          } else {
            button.className = `hotspot ${hotspot.type}`;
            const leftPercent   = (hotspot.centerX / W) * 100;
            const topPercent    = (hotspot.centerY / H) * 100;
            const widthPercent  = (hotspot.width   / W) * 100;
            const heightPercent = (hotspot.height  / H) * 100;
            button.style.cssText =
              `left:${leftPercent}%;top:${topPercent}%;` +
              `width:${widthPercent}%;height:${heightPercent}%;`;
          }

          this.stage.appendChild(button);
          this.linearOrder.push(hotspot.id);
        });

        this.buttons = {};
        this.config.hotspots.forEach(h => {
          this.buttons[h.id] = document.getElementById(h.id);
        });
      }

      setupEventListeners() {
        this.config.hotspots.forEach(hotspot => {
          const button = document.getElementById(hotspot.id);
          button.addEventListener('click', () => {
            if (button.classList.contains('locked')) return;
            this.openFor(button);
          });
        });
      }

      tcToSeconds(tc) {
        const parts = tc.split(/[;:]/).map(n => parseInt(n, 10) || 0);
        const [hh, mm, ss, ff] = [parts[0] || 0, parts[1] || 0, parts[2] || 0, parts[3] || 0];
        return hh * 3600 + mm * 60 + ss + (ff / this.FPS);
      }

      fmt(t) {
        return `${Math.floor(t / 60)}:${Math.floor(t % 60).toString().padStart(2, '0')}`;
      }

      saveDone() {
        localStorage.setItem(this.moduleKey, JSON.stringify([...this.done]));
      }

      setState(el, state) {
        el.classList.remove('clickable', 'locked', 'done');
        el.classList.add(state);
        el.setAttribute('aria-disabled', state === 'locked' ? 'true' : 'false');
      }

      applyStatesLinear() {
        this.linearOrder.forEach(id => this.setState(this.buttons[id], 'locked'));
        let unlockedOne = false;
        this.linearOrder.forEach((id) => {
          if (this.done.has(id)) this.setState(this.buttons[id], 'done');
          else if (!unlockedOne) { this.setState(this.buttons[id], 'clickable'); unlockedOne = true; }
        });
      }

      buildAudioUI(total) {
        const ui = document.createElement('div');
        ui.className = 'audio-ui';
        ui.innerHTML = `
          <div class="row">
            <div class="biglabel">Narration</div>
            <div class="time"><span id="tcur">0:00</span> / <span id="tlen">${this.fmt(total)}</span></div>
          </div>
          <div class="bar"><div class="fill" id="fill"></div></div>
          <div class="row">
            <div class="controls">
              <button class="btn" id="playPause" title="Play/Pause">▶</button>
              <button class="btn" id="replay" title="Replay">⟳</button>
            </div>
            <div class="viewer-actions">
              <span class="time" id="status">Ready</span>
              <button class="close-btn" id="closeBtn">Close</button>
              <button class="next-btn" id="nextBtn" style="display:none">Next</button>
            </div>
          </div>`;
        return ui;
      }

      closeViewer() {
        this.innerWindow.classList.remove('active');
        this.viewer.innerHTML = '';
        if (this.seg.currentVideo) { this.seg.currentVideo.pause(); this.seg.currentVideo = null; }
        if (!this.audio.paused) this.audio.pause();
        this.seg.active = false;
        cancelAnimationFrame(this.seg.rafId);
        this.closeRealLifePopup();
        this.resetHeaderActions();
      }

      showChapterCompleteDialog() {
        const overlay = document.createElement('div');
        overlay.className = 'chapter-complete-overlay';
        overlay.innerHTML = `
          <div class="chapter-complete-dialog">
            <h2>Chapter Complete!</h2>
            <p>You've finished this chapter of the training module. Would you like to continue to the next chapter?</p>
            <div class="actions">
              <button class="btn" id="stayBtn">Stay Here</button>
              <button class="btn primary" id="continueBtn">Continue to Next Chapter</button>
            </div>
          </div>`;
        document.body.appendChild(overlay);
        document.getElementById('stayBtn').onclick = () => { overlay.remove(); this.closeViewer(); };
        document.getElementById('continueBtn').onclick = () => { overlay.remove(); this.loadNextModule(); };
      }

      loadNextModule() {
        const nextIndex = this.currentModuleIndex + 1;
        if (nextIndex < MODULE_SEQUENCE.length) {
          const nextModulePath = MODULE_SEQUENCE[nextIndex];
          fetch(nextModulePath)
            .then(r => { if (!r.ok) throw new Error(`${r.status} ${r.statusText}`); return r.json(); })
            .then(config => {
              this.stage.innerHTML = '';
              new ModularTrainingSystem(config, nextIndex);
            })
            .catch(err => {
              console.error('Failed to load next module:', err);
              alert('Failed to load the next chapter. Please refresh the page.');
            });
        } else {
          alert('Congratulations! You have completed all training modules.');
        }
      }

      onSegmentComplete(id) {
        if (!this.done.has(id)) { this.done.add(id); this.saveDone(); this.applyStatesLinear(); }
        const hotspot = this.config.hotspots.find(h => h.id === id);
        const isDone = (hotspot?.order || '').toLowerCase() === 'done';
        const nextBtn = document.getElementById('nextBtn');
        if (nextBtn) {
          nextBtn.style.display = 'block';
          nextBtn.onclick = () => {
            if (isDone) {
              const isLastModule = this.currentModuleIndex === MODULE_SEQUENCE.length - 1;
              if (isLastModule) { alert('Congratulations! You have completed all training modules.'); this.closeViewer(); }
              else { this.showChapterCompleteDialog(); }
            } else { this.closeViewer(); }
          };
        }
      }

      wireAudioSegment(startSec, endSec, id) {
        const total = endSec - startSec;
        this.seg = { start: startSec, end: endSec, active: true, currentId: id, currentVideo: this.seg.currentVideo };

        const fill = document.getElementById('fill');
        const playPause = document.getElementById('playPause');
        const replay = document.getElementById('replay');
        const status = document.getElementById('status');
        const tcur = document.getElementById('tcur');
        const closeBtn = document.getElementById('closeBtn');

        const syncUI = () => {
          if (!this.seg.active) return;
          const now = Math.min(Math.max(this.audio.currentTime, this.seg.start), this.seg.end);
          const elapsed = now - this.seg.start;
          fill.style.width = `${(elapsed / total) * 100}%`;
          tcur.textContent = this.fmt(elapsed);
          if (now >= this.seg.end - 0.02) {
            this.audio.pause();
            if (this.seg.currentVideo) this.seg.currentVideo.pause();
            playPause.textContent = '▶';
            status.textContent = 'Finished';
            cancelAnimationFrame(this.seg.rafId);
            this.onSegmentComplete(id);
            return;
          }
          this.seg.rafId = requestAnimationFrame(syncUI);
        };

        const startSeg = () => {
          this.audio.currentTime = this.seg.start;
          this.audio.play().then(() => {
            if (this.seg.currentVideo) this.seg.currentVideo.play().catch(console.error);
            playPause.textContent = '❚❚';
            status.textContent = 'Playing';
            cancelAnimationFrame(this.seg.rafId);
            this.seg.rafId = requestAnimationFrame(syncUI);
          }).catch(() => { status.textContent = 'Tap Play to start audio'; });
        };

        this.audio.ontimeupdate = () => {
          if (!this.seg.active) return;
          if (this.audio.currentTime < this.seg.start) this.audio.currentTime = this.seg.start;
          if (this.audio.currentTime > this.seg.end) this.audio.currentTime = this.seg.end;
        };

        playPause.onclick = () => {
          if (this.audio.paused) {
            if (this.audio.currentTime <= this.seg.start || this.audio.currentTime >= this.seg.end) startSeg();
            else {
              this.audio.play().then(() => {
                if (this.seg.currentVideo) this.seg.currentVideo.play().catch(console.error);
                playPause.textContent = '❚❚';
                status.textContent = 'Playing';
                cancelAnimationFrame(this.seg.rafId);
                this.seg.rafId = requestAnimationFrame(syncUI);
              });
            }
          } else {
            this.audio.pause();
            if (this.seg.currentVideo) this.seg.currentVideo.pause();
            playPause.textContent = '▶';
            status.textContent = 'Paused';
          }
        };

        replay.onclick = () => startSeg();
        closeBtn.onclick = () => this.closeViewer();
        
        startSeg();
      }

      getTitleAndBody(text) {
        const m = (text || '').match(/^\s*\[([^\]]+)\]\s*\n?([\s\S]*)$/);
        return m ? { title: m[1], body: (m[2] || '').trimStart() } : { title: 'Narration', body: text || '' };
      }

      showRealLifePopup(examples) {
        this.closeRealLifePopup();
        const popup = document.createElement('div');
        popup.id = 'realLifePopup';
        popup.className = 'real-life-popup';
        popup.innerHTML = `
          <header>
            <span>Real Life Example</span>
            <button class="close-btn">×</button>
          </header>
          <div class="content">
            <img id="realLifeImg" src="${examples[0]}" alt="Real life example" />
          </div>
          <div class="nav" ${examples.length <= 1 ? 'style="display:none"' : ''}>
            <button id="prevBtn">‹ Previous</button>
            <span>${this.realLifeIndex + 1} of ${examples.length}</span>
            <button id="nextImgBtn">Next ›</button>
          </div>`;
        document.body.appendChild(popup);

        popup.querySelector('.close-btn').onclick = () => this.closeRealLifePopup();
        if (examples.length > 1) {
          const prevBtn = popup.querySelector('#prevBtn');
          const nextBtn = popup.querySelector('#nextImgBtn');
          const img = popup.querySelector('#realLifeImg');
          const counter = popup.querySelector('.nav span');

          const updateImage = () => {
            img.src = examples[this.realLifeIndex];
            counter.textContent = `${this.realLifeIndex + 1} of ${examples.length}`;
            prevBtn.disabled = this.realLifeIndex === 0;
            nextBtn.disabled = this.realLifeIndex === examples.length - 1;
          };
          prevBtn.onclick = () => { if (this.realLifeIndex > 0) { this.realLifeIndex--; updateImage(); } };
          nextBtn.onclick = () => { if (this.realLifeIndex < examples.length - 1) { this.realLifeIndex++; updateImage(); } };
          updateImage();
        }

        if (!this.audio.paused) {
          this.audio.pause();
          if (this.seg.currentVideo) this.seg.currentVideo.pause();
          const playPause = document.getElementById('playPause');
          const status = document.getElementById('status');
          if (playPause) playPause.textContent = '▶';
          if (status) status.textContent = 'Paused';
        }
      }

      closeRealLifePopup() {
        const existing = document.getElementById('realLifePopup');
        if (existing) existing.remove();
        this.realLifeIndex = 0;
      }

      resetHeaderActions() {
        const right = this.innerWindow.querySelector('header .right');
        if (!right) return;
        right.querySelectorAll('.header-real-life-btn').forEach(btn => btn.remove());
      }

      openFor(button) {
        this.resetHeaderActions();
        this.closeRealLifePopup();

        const id = button.id;
        const hotspot = this.config.hotspots.find(h => h.id === id);
        const s = this.tcToSeconds(button.dataset.tcStart);
        const e = this.tcToSeconds(button.dataset.tcEnd);

        const textContent = hotspot.content || hotspot.text || '';
        const { title, body } = this.getTitleAndBody(textContent);
        const hasVideo = hotspot.video;
        const hasRealLife = hotspot.realLifeExamples && hotspot.realLifeExamples.length > 0;

        this.innerWindow.classList.remove('small', 'large');
        this.viewer.innerHTML = '';
        this.viewerTitle.textContent = title || 'Narration';

        if (hasVideo) {
          this.innerWindow.classList.add('large');
          const mediaArea = document.createElement('div');
          mediaArea.className = 'mediaArea';

          const video = document.createElement('video');
          video.src = hotspot.video;
          video.autoplay = true;
          video.muted = true;
          video.playsInline = true;
          video.loop = true;
          video.controls = false;
          mediaArea.appendChild(video);
          this.seg.currentVideo = video;

          video.addEventListener('loadedmetadata', () => { video.play().catch(()=>{}); });

          const caption = document.createElement('div');
          caption.className = 'caption';
          caption.textContent = body;
          mediaArea.appendChild(caption);

          this.viewer.appendChild(mediaArea);

          if (hasRealLife) {
            const rightSection = this.innerWindow.querySelector('header .right');
            const realLifeBtn = document.createElement('button');
            realLifeBtn.className = 'header-real-life-btn';
            realLifeBtn.textContent = 'Real Life Example';
            realLifeBtn.onclick = () => this.showRealLifePopup(hotspot.realLifeExamples);
            rightSection.insertBefore(realLifeBtn, rightSection.firstChild);
          }
        } else {
          this.innerWindow.classList.add('small');
          const wrap = document.createElement('div');
          wrap.className = 'subs-only';
          const text = document.createElement('div');
          text.className = 'subs-text';
          text.textContent = body;
          this.viewer.appendChild(wrap);
          wrap.appendChild(text);
        }

        this.viewer.appendChild(this.buildAudioUI(e - s));
        this.innerWindow.classList.add('active');
        this.wireAudioSegment(s, e, id);
      }
    }

    (function boot(){
      const title = document.getElementById('moduleTitle');
      const startup = document.getElementById('startup');

      if (LocalDebugMode) {
        // DEBUG: show overlay
        title.textContent = 'Select your utilities_config.json…';
        startup.style.display = 'grid';

        const picker = document.getElementById('configPicker');
        const pickBtn = document.getElementById('pickBtn');
        const drop = document.getElementById('drop');
        const hint = document.getElementById('hint');

        const parseAndInit = (cfg, label='') => {
          try {
            if (typeof cfg === 'string') cfg = JSON.parse(cfg);
            startup.remove();                        // hide overlay after parse
            new ModularTrainingSystem(cfg, 0);
          } catch (e) {
            if (hint) hint.textContent = 'Invalid JSON: ' + (e?.message || e);
          }
        };

        const readFile = (file) => new Promise((resolve, reject) => {
          const r = new FileReader();
          r.onload = () => resolve(String(r.result));
          r.onerror = () => reject(r.error || new Error('Failed to read file'));
          r.readAsText(file, 'utf-8');
        });

        pickBtn?.addEventListener('click', () => { picker.value = ''; picker.click(); });
        picker?.addEventListener('change', async () => {
          const f = picker.files && picker.files[0];
          if (!f) return;
          try { parseAndInit(await readFile(f), f.name); }
          catch (e) { hint.textContent = 'Failed to read file: ' + (e?.message || e); }
        });

        ['dragenter','dragover'].forEach(ev => {
          drop?.addEventListener(ev, (e) => { e.preventDefault(); e.stopPropagation(); drop.classList.add('dragover'); });
        });
        ['dragleave','drop'].forEach(ev => {
          drop?.addEventListener(ev, (e) => { e.preventDefault(); e.stopPropagation(); drop.classList.remove('dragover'); });
        });
        drop?.addEventListener('drop', async (e) => {
          const file = e.dataTransfer.files && e.dataTransfer.files[0];
          if (!file) return;
          try { parseAndInit(await readFile(file), file.name); }
          catch (err) { hint.textContent = 'Failed to read dropped file: ' + (err?.message || err); }
        });

        const urlParams = new URLSearchParams(window.location.search);
        const configURL = urlParams.get('config');
        if (configURL) {
          hint.textContent = 'Loading config from URL…';
          fetch(configURL)
            .then(r => { if (!r.ok) throw new Error(r.status + ' ' + r.statusText); return r.text(); })
            .then(text => parseAndInit(text, configURL))
            .catch(err => { hint.textContent = 'Failed to load ?config: ' + (err?.message || err); });
        } else {
          hint.textContent = 'Debug mode: Select a JSON config file to continue';
        }

      } else {
        // PRODUCTION: hide overlay and auto-load first module
        startup.style.display = 'none';               // ensure hidden
        title.textContent = 'Loading Training Module...';
        const firstModulePath = MODULE_SEQUENCE[0];

        fetch(firstModulePath)
          .then(r => { if (!r.ok) throw new Error(`${r.status} ${r.statusText}`); return r.json(); })
          .then(config => {
            startup.remove?.();                       // remove overlay if still in DOM
            new ModularTrainingSystem(config, 0);
          })
          .catch(err => {
            console.error('Failed to load module:', err);
            title.textContent = 'Failed to load training module';
            alert('Failed to load the training module. Please check that all files are available and refresh the page.');
          });
      }
    })();
  </script>
</body>
</html>
